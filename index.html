<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tá»• áº¤m ğŸ¡</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
/* â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:       #FAF7F2;
  --surface:  #FFFFFF;
  --surface2: #FDF9F4;
  --border:   #EDE8E0;
  --peach:    #E8A87C;
  --peach-l:  #F5DCC8;
  --peach-xl: #FDF0E6;
  --rose:     #D4877A;
  --rose-l:   #F2D5D0;
  --sage:     #7FAF8A;
  --sage-l:   #C8DFD0;
  --sage-xl:  #EAF4EE;
  --lav:      #9B8EC4;
  --lav-l:    #D8D0F0;
  --lav-xl:   #F0EDF8;
  --amber:    #C9A84C;
  --amber-l:  #EEE0B0;
  --amber-xl: #FBF6E8;
  --ink:      #2C2420;
  --ink2:     #6B5C54;
  --ink3:     #A08880;
  --r:        18px;
  --r-sm:     12px;
  --sh:       0 2px 16px rgba(44,36,32,.07);
  --sh-lg:    0 8px 32px rgba(44,36,32,.12);
}

/* â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
html { -webkit-tap-highlight-color:transparent; }
body {
  font-family:'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--peach-l); border-radius:4px; }

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast {
  position:fixed; bottom:90px; left:50%; transform:translateX(-50%) translateY(12px);
  background:var(--ink); color:#fff; border-radius:24px; padding:.55rem 1.3rem;
  font-size:.8rem; font-weight:500; z-index:9999; opacity:0;
  transition:all .3s cubic-bezier(.34,1.56,.64,1); pointer-events:none; white-space:nowrap;
}
#toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
#toast.err  { background:var(--rose); }
#toast.ok   { background:var(--sage); }

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  padding: 1.6rem 1.2rem 1rem;
  background: linear-gradient(160deg, #FDF0E4 0%, #FBF0F5 55%, #F0F5EC 100%);
  border-bottom: 1px solid var(--border);
  text-align: center;
  position: relative;
  overflow: hidden;
}
.header::before {
  content:'';
  position:absolute; inset:0;
  background: radial-gradient(ellipse 80% 60% at 50% -10%, rgba(232,168,124,.18), transparent);
  pointer-events:none;
}
.header-icon { font-size:2.2rem; line-height:1; animation:bob 4s ease-in-out infinite; display:block; }
@keyframes bob { 0%,100%{transform:translateY(0) rotate(-2deg)} 50%{transform:translateY(-5px) rotate(2deg)} }
.header h1 {
  font-family:'Cormorant Garamond', serif;
  font-size:1.75rem; font-weight:600; color:var(--ink);
  margin:.35rem 0 .2rem; letter-spacing:-.01em;
}
.header-sub { font-size:.78rem; color:var(--ink3); font-style:italic; }
.date-chip {
  display:inline-block; margin-top:.6rem;
  background:rgba(255,255,255,.8); border:1px solid var(--border);
  border-radius:20px; padding:.22rem .9rem;
  font-size:.72rem; color:var(--ink2); font-weight:500;
  backdrop-filter:blur(8px);
}

/* â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.nav {
  position:sticky; top:0; z-index:40;
  background:rgba(250,247,242,.92); backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  padding:.55rem .8rem .45rem;
  display:flex; gap:.35rem; overflow-x:auto;
  justify-content:center; scrollbar-width:none;
}
.nav::-webkit-scrollbar { display:none; }
.nav-btn {
  flex-shrink:0; border:1.5px solid transparent;
  border-radius:22px; padding:.38rem .85rem;
  background:transparent; font-family:'DM Sans',sans-serif;
  font-size:.75rem; font-weight:500; cursor:pointer;
  color:var(--ink3); transition:all .2s; white-space:nowrap;
  display:flex; align-items:center; gap:.3rem;
}
.nav-btn:hover { color:var(--ink); background:var(--surface); box-shadow:var(--sh); }
.nav-btn.on { background:var(--surface); box-shadow:var(--sh); color:var(--ink); font-weight:600; }
.nav-btn.on[data-t=home]    { border-color:var(--peach); }
.nav-btn.on[data-t=finance] { border-color:var(--amber); color:var(--amber); }
.nav-btn.on[data-t=chores]  { border-color:var(--sage);  color:var(--sage); }
.nav-btn.on[data-t=notes]   { border-color:var(--lav);   color:var(--lav); }
.nav-btn.on[data-t=dreams]  { border-color:var(--peach); color:var(--rose); }
.nav-btn.on[data-t=ai]      { border-color:#7BA3E8; color:#5A7AC8; }

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { max-width:560px; margin:0 auto; padding:1rem .9rem 6rem; }

/* â”€â”€ PAGE FADE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page { animation:pagein .25s ease; }
@keyframes pagein { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background:var(--surface); border-radius:var(--r);
  border:1px solid var(--border); box-shadow:var(--sh);
  padding:1.1rem 1.1rem .9rem; margin-bottom:.8rem;
}
.card-title {
  font-family:'Cormorant Garamond', serif;
  font-size:1.05rem; font-weight:600; color:var(--ink);
  margin-bottom:.85rem; display:flex; align-items:center; gap:.4rem;
}

/* â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field { margin-bottom:.55rem; }
.field label { font-size:.72rem; font-weight:600; color:var(--ink2); display:block; margin-bottom:.25rem; letter-spacing:.02em; text-transform:uppercase; }
input, select, textarea {
  font-family:'DM Sans',sans-serif; font-size:.85rem;
  border:1.5px solid var(--border); border-radius:var(--r-sm);
  padding:.58rem .8rem; width:100%;
  background:var(--surface2); color:var(--ink); outline:none;
  transition:border-color .2s, box-shadow .2s;
  -webkit-appearance:none;
}
input:focus, select:focus, textarea:focus {
  border-color:var(--peach); box-shadow:0 0 0 3px var(--peach-xl);
  background:var(--surface);
}
textarea { resize:vertical; min-height:72px; line-height:1.55; }
.row2 { display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }

/* â”€â”€ BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display:inline-flex; align-items:center; justify-content:center; gap:.4rem;
  padding:.6rem 1.2rem; border-radius:22px; border:none;
  font-family:'DM Sans',sans-serif; font-size:.82rem; font-weight:600;
  cursor:pointer; transition:all .18s; white-space:nowrap;
}
.btn:hover { filter:brightness(1.06); transform:translateY(-1px); }
.btn:active { transform:translateY(0); filter:brightness(.97); }
.btn-full { width:100%; margin-top:.55rem; }
.btn-sm { padding:.35rem .8rem; font-size:.75rem; }
.btn-peach   { background:var(--peach);   color:#fff; }
.btn-sage    { background:var(--sage);    color:#fff; }
.btn-lav     { background:var(--lav);     color:#fff; }
.btn-amber   { background:var(--amber);   color:#fff; }
.btn-rose    { background:var(--rose);    color:#fff; }
.btn-outline { background:transparent; border:1.5px solid var(--border); color:var(--ink2); }
.btn-outline:hover { border-color:var(--peach); color:var(--ink); }

/* â”€â”€ PILLS / CHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pills { display:flex; flex-wrap:wrap; gap:.35rem; margin-bottom:.6rem; }
.pill {
  padding:.3rem .8rem; border-radius:20px;
  border:1.5px solid var(--border); background:var(--surface2);
  font-size:.75rem; font-weight:500; cursor:pointer; color:var(--ink2);
  transition:all .18s; font-family:'DM Sans',sans-serif;
}
.pill:hover { border-color:var(--peach-l); color:var(--ink); }
.pill.on { background:var(--peach-xl); border-color:var(--peach); color:var(--peach); font-weight:600; }
.pill.on-sage  { background:var(--sage-xl);  border-color:var(--sage);  color:var(--sage); font-weight:600; }
.pill.on-lav   { background:var(--lav-xl);   border-color:var(--lav);   color:var(--lav); font-weight:600; }
.pill.on-amber { background:var(--amber-xl); border-color:var(--amber); color:var(--amber); font-weight:600; }

/* â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec {
  font-size:.68rem; font-weight:600; letter-spacing:.1em; text-transform:uppercase;
  color:var(--ink3); margin:1rem 0 .5rem;
  display:flex; align-items:center; gap:.5rem;
}
.sec::after { content:''; flex:1; height:1px; background:var(--border); }

/* â”€â”€ EMPTY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty { text-align:center; padding:1.8rem 1rem; color:var(--ink3); }
.empty-icon { font-size:2rem; display:block; margin-bottom:.5rem; opacity:.4; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.welcome {
  border-radius:var(--r); overflow:hidden;
  background:linear-gradient(135deg, #FDF0E6 0%, #F8ECF4 50%, #ECF5EE 100%);
  border:1px solid var(--border); padding:1.3rem;
  margin-bottom:.8rem; text-align:center; position:relative;
}
.welcome::after {
  content:'ğŸ±ğŸ±ğŸ±ğŸ±ğŸ±';
  position:absolute; bottom:-.3rem; right:.8rem;
  font-size:.9rem; opacity:.25; letter-spacing:.15rem;
}
.welcome-title {
  font-family:'Cormorant Garamond',serif;
  font-size:1.3rem; font-weight:600; color:var(--ink);
}
.welcome-sub { font-size:.78rem; color:var(--ink2); margin-top:.3rem; line-height:1.6; }

.stat-row { display:grid; grid-template-columns:repeat(3,1fr); gap:.6rem; margin-bottom:.8rem; }
.stat-box {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r-sm); padding:.8rem .6rem; text-align:center;
  box-shadow:var(--sh);
}
.stat-num {
  font-family:'Cormorant Garamond',serif;
  font-size:1.35rem; font-weight:600; color:var(--ink); line-height:1;
}
.stat-label { font-size:.65rem; color:var(--ink3); margin-top:.25rem; font-weight:500; }

.home-grid { display:grid; grid-template-columns:1fr 1fr; gap:.65rem; margin-bottom:.8rem; }
.home-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r); padding:1rem; text-align:center;
  cursor:pointer; transition:all .22s; box-shadow:var(--sh);
  position:relative; overflow:hidden;
}
.home-card::before {
  content:''; position:absolute; inset:0; opacity:0;
  transition:opacity .22s;
}
.home-card:hover { transform:translateY(-3px); box-shadow:var(--sh-lg); }
.home-card:hover::before { opacity:1; }
.hc-finance::before { background:linear-gradient(135deg,var(--amber-xl),transparent); }
.hc-chores::before  { background:linear-gradient(135deg,var(--sage-xl),transparent); }
.hc-notes::before   { background:linear-gradient(135deg,var(--lav-xl),transparent); }
.hc-dreams::before  { background:linear-gradient(135deg,var(--peach-xl),transparent); }
.hc-emoji { font-size:1.7rem; display:block; margin-bottom:.4rem; }
.hc-title { font-weight:600; font-size:.85rem; color:var(--ink); }
.hc-sub   { font-size:.68rem; color:var(--ink3); margin-top:.15rem; }

.love-wrap { background:var(--surface); border:1px solid var(--border); border-radius:var(--r); padding:1rem; box-shadow:var(--sh); }
.love-input-row { display:flex; gap:.45rem; align-items:flex-end; }
.love-input-row textarea { flex:1; min-height:44px; max-height:80px; }
.love-list { margin-top:.7rem; display:flex; flex-direction:column; gap:.4rem; }
.love-item {
  background:var(--peach-xl); border-left:3px solid var(--peach);
  border-radius:0 var(--r-sm) var(--r-sm) 0; padding:.6rem .8rem;
  font-size:.8rem; font-style:italic; color:var(--ink);
}
.love-time { float:right; font-size:.68rem; color:var(--ink3); font-style:normal; margin-left:.5rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FINANCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.balance-hero {
  border-radius:var(--r); padding:1.3rem;
  background:linear-gradient(135deg, #FBF5E4 0%, #FDF8F0 100%);
  border:1px solid var(--amber-l); margin-bottom:.8rem; text-align:center;
}
.balance-label { font-size:.72rem; color:var(--ink2); font-weight:500; margin-bottom:.25rem; }
.balance-num {
  font-family:'Cormorant Garamond',serif;
  font-size:2.2rem; font-weight:600; color:var(--ink);
  letter-spacing:-.02em; line-height:1.1;
}
.balance-split { display:flex; justify-content:center; gap:1rem; margin-top:.7rem; }
.bal-in  { background:var(--sage-xl);  border:1px solid var(--sage-l);  color:var(--sage);  border-radius:20px; padding:.25rem .8rem; font-size:.75rem; font-weight:600; }
.bal-out { background:var(--rose-l);   border:1px solid var(--rose-l);  color:var(--rose);  border-radius:20px; padding:.25rem .8rem; font-size:.75rem; font-weight:600; }

.filter-row { display:flex; align-items:center; gap:.45rem; flex-wrap:wrap; margin-bottom:.8rem; }
.month-ctrl { display:flex; align-items:center; gap:.2rem; background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:.25rem .5rem; }
.month-ctrl button { background:none; border:none; cursor:pointer; color:var(--ink2); font-size:.95rem; padding:0 .2rem; line-height:1; transition:color .15s; }
.month-ctrl button:hover { color:var(--peach); }
.month-ctrl span { font-size:.76rem; font-weight:600; color:var(--ink); min-width:50px; text-align:center; }

.tx-list { max-height:290px; overflow-y:auto; display:flex; flex-direction:column; gap:.4rem; }
.tx-item {
  display:flex; align-items:center; gap:.6rem;
  padding:.65rem .8rem; border-radius:var(--r-sm);
  border:1px solid transparent; transition:all .18s;
}
.tx-item:hover { transform:translateX(3px); }
.tx-item.income  { background:var(--sage-xl);  border-color:var(--sage-l); }
.tx-item.expense { background:#FFF8F6; border-color:var(--rose-l); }
.tx-desc  { font-size:.83rem; font-weight:500; }
.tx-meta  { font-size:.68rem; color:var(--ink3); margin-top:.06rem; }
.tx-amt   { font-weight:600; font-size:.88rem; margin-left:auto; flex-shrink:0; }
.tx-amt.income  { color:var(--sage); }
.tx-amt.expense { color:var(--rose); }
.del-btn { background:none; border:none; cursor:pointer; color:var(--ink3); font-size:.8rem; padding:.15rem .25rem; opacity:.4; transition:opacity .15s; flex-shrink:0; }
.del-btn:hover { opacity:.9; color:var(--rose); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHORES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.prog-bar-wrap { margin-bottom:.85rem; }
.prog-head { display:flex; justify-content:space-between; font-size:.72rem; color:var(--ink3); margin-bottom:.35rem; font-weight:500; }
.prog-track { height:6px; background:var(--sage-l); border-radius:6px; overflow:hidden; }
.prog-fill  { height:100%; background:linear-gradient(90deg,var(--sage-l),var(--sage)); border-radius:6px; transition:width .4s cubic-bezier(.4,0,.2,1); }

.chore-list { display:flex; flex-direction:column; gap:.4rem; max-height:330px; overflow-y:auto; }
.chore-item {
  display:flex; align-items:center; gap:.65rem;
  padding:.7rem .85rem; border-radius:var(--r-sm);
  background:var(--surface2); border:1px solid var(--border); transition:all .18s;
}
.chore-item.done { opacity:.55; }
.chore-item.done .chore-name { text-decoration:line-through; color:var(--ink3); }
.chore-check {
  width:22px; height:22px; border-radius:50%;
  border:2px solid var(--sage-l); background:var(--surface);
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:.7rem; flex-shrink:0; transition:all .2s; color:transparent;
}
.chore-check:hover { border-color:var(--sage); }
.chore-item.done .chore-check { background:var(--sage); border-color:var(--sage); color:#fff; }
.chore-name   { font-size:.85rem; font-weight:500; flex:1; }
.chore-assign { font-size:.7rem; color:var(--ink3); }
.chore-freq {
  font-size:.67rem; padding:.18rem .55rem; border-radius:10px;
  background:var(--sage-l); color:var(--sage); font-weight:600; flex-shrink:0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.notes-masonry { display:grid; grid-template-columns:1fr 1fr; gap:.65rem; }
.note-card {
  border-radius:14px; padding:.9rem; border:1px solid transparent;
  cursor:default; transition:all .22s; position:relative; min-height:100px;
  display:flex; flex-direction:column;
}
.note-card:hover { transform:translateY(-3px) rotate(.5deg); box-shadow:var(--sh-lg); }
.nc-1 { background:#FEFBE8; border-color:#E8DFA0; }
.nc-2 { background:var(--lav-xl); border-color:var(--lav-l); }
.nc-3 { background:var(--sage-xl); border-color:var(--sage-l); }
.nc-4 { background:#FFF4F2; border-color:var(--rose-l); }
.nc-5 { background:var(--peach-xl); border-color:var(--peach-l); }
.note-tag { font-size:.62rem; font-weight:700; letter-spacing:.06em; text-transform:uppercase; opacity:.5; margin-bottom:.3rem; }
.note-title { font-weight:600; font-size:.83rem; margin-bottom:.3rem; color:var(--ink); }
.note-body  { font-size:.75rem; color:var(--ink2); flex:1; line-height:1.55; }
.note-date  { font-size:.65rem; color:var(--ink3); margin-top:.5rem; }
.note-del   { position:absolute; top:.45rem; right:.45rem; background:none; border:none; cursor:pointer; font-size:.8rem; opacity:0; color:var(--ink3); transition:opacity .15s; padding:.1rem; }
.note-card:hover .note-del { opacity:.5; }
.note-del:hover { opacity:.9 !important; color:var(--rose); }

.event-list { display:flex; flex-direction:column; gap:.4rem; }
.event-item {
  display:flex; align-items:center; gap:.65rem;
  padding:.6rem .8rem; background:var(--lav-xl);
  border-radius:var(--r-sm); border:1px solid var(--lav-l); transition:all .18s;
}
.event-item:hover { transform:translateX(3px); }
.ev-date { background:var(--surface); border-radius:8px; padding:.3rem .55rem; text-align:center; flex-shrink:0; min-width:44px; border:1px solid var(--lav-l); }
.ev-day   { font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:600; color:var(--lav); line-height:1; }
.ev-month { font-size:.62rem; color:var(--ink3); font-weight:600; }
.ev-name  { font-size:.84rem; font-weight:500; }
.ev-who   { font-size:.68rem; color:var(--ink3); margin-top:.05rem; }
.ev-badge { font-size:.64rem; font-weight:700; padding:.15rem .45rem; border-radius:8px; flex-shrink:0; margin-left:auto; }
.ev-b-chung  { background:var(--lav-l); color:var(--lav); }
.ev-b-rieng  { background:var(--peach-l); color:var(--peach); }
.ev-diff { color:var(--rose); font-size:.65rem; font-weight:600; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DREAMS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dream-item {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r); padding:.95rem 1rem;
  margin-bottom:.7rem; transition:all .22s; box-shadow:var(--sh);
}
.dream-item:hover { box-shadow:var(--sh-lg); transform:translateY(-2px); }
.dream-item.done { opacity:.7; border-color:var(--sage-l); background:var(--sage-xl); }
.dr-top { display:flex; align-items:flex-start; gap:.5rem; margin-bottom:.5rem; }
.dr-title { font-weight:600; font-size:.9rem; flex:1; color:var(--ink); }
.dr-cat { font-size:.65rem; padding:.16rem .52rem; border-radius:9px; font-weight:600; flex-shrink:0; }
.dc-travel { background:var(--lav-xl); color:var(--lav); }
.dc-home   { background:var(--peach-xl); color:var(--peach); }
.dc-life   { background:var(--sage-xl); color:var(--sage); }
.dc-money  { background:var(--amber-xl); color:var(--amber); }
.dr-note { font-size:.76rem; color:var(--ink2); margin-bottom:.6rem; line-height:1.55; }
.dr-prog-label { display:flex; justify-content:space-between; font-size:.7rem; color:var(--ink3); margin-bottom:.28rem; font-weight:500; }
.dr-track { height:6px; background:var(--peach-l); border-radius:6px; overflow:hidden; margin-bottom:.5rem; }
.dr-fill  { height:100%; background:linear-gradient(90deg,var(--peach),var(--rose)); border-radius:6px; transition:width .4s; }
.dream-item.done .dr-fill { background:linear-gradient(90deg,var(--sage-l),var(--sage)); }
input[type=range] {
  -webkit-appearance:none; appearance:none; width:100%; height:4px;
  background:var(--peach-l); border-radius:4px; outline:none; border:none; padding:0;
  cursor:pointer; margin:.25rem 0 .6rem;
  background:linear-gradient(to right, var(--peach) 0%, var(--peach) var(--pct,0%), var(--peach-l) var(--pct,0%), var(--peach-l) 100%);
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:16px; height:16px; border-radius:50%;
  background:var(--peach); border:2px solid #fff; box-shadow:0 1px 4px rgba(0,0,0,.18); cursor:pointer;
}
.dr-footer { display:flex; justify-content:space-between; align-items:center; }
.dr-done-btn {
  background:none; border:1.5px solid var(--border); border-radius:10px;
  padding:.24rem .7rem; font-size:.72rem; font-weight:600; cursor:pointer;
  color:var(--ink2); font-family:'DM Sans',sans-serif; transition:all .18s;
}
.dr-done-btn:hover { border-color:var(--peach); color:var(--peach); }
.dream-item.done .dr-done-btn { border-color:var(--sage); color:var(--sage); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ai-banner {
  background:linear-gradient(135deg,#EEF3FF,#F2EEFF); border-radius:var(--r);
  border:1px solid #C8D0F0; padding:1rem 1.1rem; margin-bottom:.8rem; text-align:center;
}
.ai-banner h3 { font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:600; color:var(--ink); }
.ai-banner p { font-size:.75rem; color:var(--ink2); margin-top:.25rem; line-height:1.6; }

.suggest-wrap { display:flex; flex-wrap:wrap; gap:.35rem; margin-bottom:.75rem; }
.suggest-chip {
  background:var(--surface); border:1px solid var(--border); border-radius:18px;
  padding:.3rem .8rem; font-size:.73rem; font-weight:500; color:#5A7AC8;
  cursor:pointer; transition:all .18s; font-family:'DM Sans',sans-serif;
}
.suggest-chip:hover { background:#EEF3FF; border-color:#A8C0F0; transform:translateY(-1px); }

.chat-box {
  background:var(--surface); border:1px solid var(--border); border-radius:var(--r);
  overflow:hidden; display:flex; flex-direction:column; height:360px;
  margin-bottom:.8rem; box-shadow:var(--sh);
}
.chat-msgs { flex:1; overflow-y:auto; padding:.9rem; display:flex; flex-direction:column; gap:.7rem; }
.msg { display:flex; gap:.5rem; align-items:flex-end; }
.msg.user { flex-direction:row-reverse; }
.msg-av {
  width:28px; height:28px; border-radius:50%;
  display:flex; align-items:center; justify-content:center; font-size:.85rem;
  flex-shrink:0;
}
.msg.ai   .msg-av { background:#EEF3FF; }
.msg.user .msg-av { background:var(--peach-xl); }
.msg-bub {
  max-width:80%; padding:.65rem .85rem; border-radius:14px;
  font-size:.81rem; line-height:1.58;
}
.msg.ai   .msg-bub { background:#F2F6FF; border:1px solid #D8E4F8; border-bottom-left-radius:3px; }
.msg.user .msg-bub { background:var(--peach-xl); border:1px solid var(--peach-l); border-bottom-right-radius:3px; }
.act-tag {
  display:inline-block; border-radius:7px; padding:.1rem .42rem;
  font-size:.68rem; font-weight:600; margin-top:.32rem;
}
.at-f { background:var(--amber-xl); color:var(--amber); }
.at-c { background:var(--sage-xl);  color:var(--sage); }
.at-d { background:var(--peach-xl); color:var(--peach); }
.at-n { background:var(--lav-xl);   color:var(--lav); }
.typing-dots { display:flex; gap:4px; padding:2px 0; }
.typing-dots span { width:6px; height:6px; background:#A8C0F0; border-radius:50%; animation:tdot 1.2s infinite; }
.typing-dots span:nth-child(2) { animation-delay:.2s; }
.typing-dots span:nth-child(3) { animation-delay:.4s; }
@keyframes tdot { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-5px)} }

.chat-input-row {
  display:flex; gap:.4rem; padding:.65rem;
  border-top:1px solid var(--border); background:var(--surface2);
  align-items:flex-end;
}
.chat-input-row textarea { flex:1; min-height:38px; max-height:90px; resize:none; line-height:1.4; font-size:.82rem; padding:.52rem .75rem; }
.send-btn {
  width:38px; height:38px; border-radius:50%; background:#A8C0F0; border:none;
  cursor:pointer; font-size:.9rem; display:flex; align-items:center; justify-content:center;
  transition:all .18s; flex-shrink:0; color:#fff;
}
.send-btn:hover { background:#8AAAE8; transform:scale(1.05); }
.send-btn:disabled { opacity:.45; cursor:not-allowed; transform:none; }
.mic-btn {
  width:38px; height:38px; border-radius:50%; background:var(--rose); border:none;
  cursor:pointer; font-size:.85rem; display:flex; align-items:center; justify-content:center;
  transition:all .18s; flex-shrink:0; color:#fff;
}
.mic-btn:hover { background:var(--rose-d,#b06860); }
.mic-btn.rec { animation:pulse 1s infinite; }
@keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

.tip-card {
  background:var(--surface); border:1px solid var(--border); border-radius:var(--r-sm);
  padding:.85rem 1rem; font-size:.75rem; color:var(--ink2); line-height:1.9;
}

/* â”€â”€ MODAL OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay {
  position:fixed; inset:0; background:rgba(44,36,32,.35);
  backdrop-filter:blur(6px); z-index:200;
  display:flex; align-items:center; justify-content:center; padding:1rem;
  opacity:0; pointer-events:none; transition:opacity .22s;
}
.overlay.open { opacity:1; pointer-events:all; }
.modal {
  background:var(--surface); border-radius:24px; padding:1.4rem;
  width:100%; max-width:440px; max-height:88vh; overflow-y:auto;
  box-shadow:var(--sh-lg); transform:scale(.96) translateY(10px);
  transition:transform .25s cubic-bezier(.34,1.56,.64,1);
  border:1px solid var(--border);
}
.overlay.open .modal { transform:scale(1) translateY(0); }
.modal-title {
  font-family:'Cormorant Garamond',serif; font-size:1.2rem; font-weight:600;
  color:var(--ink); margin-bottom:1rem; text-align:center;
}

/* â”€â”€ CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-section { padding:.4rem 0 .2rem; }
.chart-label { font-size:.72rem; font-weight:600; color:var(--ink3); margin-bottom:.5rem; letter-spacing:.04em; text-transform:uppercase; }
</style>
</head>
<body>

<!-- TOAST -->
<div id="toast"></div>

<!-- APP -->
<div id="app">

<!-- HEADER -->
<header class="header">
  <span class="header-icon">ğŸ¡</span>
  <h1>Tá»• áº¤m Cá»§a ChÃºng MÃ¬nh</h1>
  <div class="header-sub">Äáº¡t & TLinh Â· 5 bÃ© mÃ¨o ğŸ±</div>
  <div class="date-chip" id="date-chip"></div>
</header>

<!-- NAV -->
<nav class="nav">
  <button class="nav-btn on" data-t="home"    onclick="go('home',this)">ğŸ  Tá»• áº¤m</button>
  <button class="nav-btn"    data-t="finance" onclick="go('finance',this)">ğŸ’° Thu Chi</button>
  <button class="nav-btn"    data-t="chores"  onclick="go('chores',this)">ğŸ§¹ Viá»‡c NhÃ </button>
  <button class="nav-btn"    data-t="notes"   onclick="go('notes',this)">ğŸ“ Ghi ChÃº</button>
  <button class="nav-btn"    data-t="dreams"  onclick="go('dreams',this)">ğŸŒŸ Æ¯á»›c MÆ¡</button>
  <button class="nav-btn"    data-t="ai"      onclick="go('ai',this)">ğŸ¤– Trá»£ LÃ½</button>
</nav>

<!-- MAIN -->
<main class="main" id="main"></main>

</div><!-- #app -->

<!-- MODALS -->
<div class="overlay" id="modal-note" onclick="if(event.target===this)closeModal('modal-note')">
  <div class="modal">
    <div class="modal-title">ğŸ“ Ghi ChÃº Má»›i</div>
    <div class="field"><label>TiÃªu Ä‘á»</label><input id="n-title" placeholder="TiÃªu Ä‘á»..."/></div>
    <div class="field"><label>Ná»™i dung</label><textarea id="n-body" placeholder="Viáº¿t gÃ¬ Ä‘Ã³..."></textarea></div>
    <div class="field">
      <label>NhÃ£n</label>
      <div class="pills" id="n-tag-pills">
        <span class="pill on" data-v="Ghi nhá»›" onclick="pickPill(this,'n-tag-pills')">ğŸ“Œ Ghi nhá»›</span>
        <span class="pill" data-v="CÃ¹ng nhau" onclick="pickPill(this,'n-tag-pills')">ğŸ’• CÃ¹ng nhau</span>
        <span class="pill" data-v="Mua sáº¯m"   onclick="pickPill(this,'n-tag-pills')">ğŸ›’ Mua sáº¯m</span>
        <span class="pill" data-v="Ã tÆ°á»Ÿng"   onclick="pickPill(this,'n-tag-pills')">ğŸ’¡ Ã tÆ°á»Ÿng</span>
      </div>
    </div>
    <button class="btn btn-lav btn-full" onclick="addNote()">ğŸ’¾ LÆ°u Ghi ChÃº</button>
  </div>
</div>

<div class="overlay" id="modal-event" onclick="if(event.target===this)closeModal('modal-event')">
  <div class="modal">
    <div class="modal-title">ğŸ“… Sá»± Kiá»‡n Má»›i</div>
    <div class="field"><label>TÃªn sá»± kiá»‡n</label><input id="ev-name" placeholder="vd: Ká»· niá»‡m 1 nÄƒm yÃªu..."/></div>
    <div class="row2">
      <div class="field"><label>NgÃ y</label><input id="ev-date" type="date"/></div>
      <div class="field">
        <label>Loáº¡i</label>
        <div class="pills" id="ev-type-pills" style="margin-top:.2rem">
          <span class="pill on-lav on" data-v="chung"  onclick="pickPill(this,'ev-type-pills')">ğŸ’‘ Chung</span>
          <span class="pill"           data-v="rieng"  onclick="pickPill(this,'ev-type-pills')">ğŸ‘¤ CÃ¡ nhÃ¢n</span>
        </div>
      </div>
    </div>
    <div class="field">
      <label>Ai</label>
      <select id="ev-who"><option>Cáº£ hai</option><option>Äáº¡t</option><option>TLinh</option></select>
    </div>
    <button class="btn btn-lav btn-full" onclick="addEvent()">ğŸ“… LÆ°u Sá»± Kiá»‡n</button>
  </div>
</div>

<div class="overlay" id="modal-dream" onclick="if(event.target===this)closeModal('modal-dream')">
  <div class="modal">
    <div class="modal-title">ğŸŒŸ Æ¯á»›c MÆ¡ Má»›i</div>
    <div class="field"><label>TÃªn Æ°á»›c mÆ¡</label><input id="dr-title" placeholder="vd: Du lá»‹ch ÄÃ  Láº¡t cÃ¹ng nhau..."/></div>
    <div class="field"><label>Ghi chÃº</label><textarea id="dr-note" placeholder="MÃ´ táº£ thÃªm..." style="min-height:56px"></textarea></div>
    <div class="field">
      <label>Danh má»¥c</label>
      <div class="pills" id="dr-cat-pills">
        <span class="pill on" data-v="travel" onclick="pickPill(this,'dr-cat-pills')">âœˆï¸ Du lá»‹ch</span>
        <span class="pill"    data-v="home"   onclick="pickPill(this,'dr-cat-pills')">ğŸ  Tá»• áº¥m</span>
        <span class="pill"    data-v="life"   onclick="pickPill(this,'dr-cat-pills')">ğŸ’‘ Cuá»™c sá»‘ng</span>
        <span class="pill"    data-v="money"  onclick="pickPill(this,'dr-cat-pills')">ğŸ’° TÃ i chÃ­nh</span>
      </div>
    </div>
    <div class="field">
      <label>Tiáº¿n Ä‘á»™ â€” <span id="dr-prog-val">0</span>%</label>
      <input type="range" id="dr-progress" min="0" max="100" value="0"
        oninput="document.getElementById('dr-prog-val').textContent=this.value;updateRangeStyle(this)"/>
    </div>
    <button class="btn btn-peach btn-full" onclick="addDream()">ğŸŒŸ ThÃªm Æ¯á»›c MÆ¡</button>
  </div>
</div>

<script>
// â”€â”€ SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SB = supabase.createClient(
  'https://jdbublamnvzjspmmqldf.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkYnVibGFtbnZ6anNwbW1xbGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNzI4MDgsImV4cCI6MjA4NzY0ODgwOH0.8HJo46GvdepnIM0PCqFzYdhBBjhZn_F6RFK6I3EAMmI'
);

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);
const fmt = n => Number(n||0).toLocaleString('vi-VN')+'Ä‘';
const vnd = s => { s=String(s||0).toLowerCase().replace(/,/g,'').trim(); if(s.includes('triá»‡u'))return Math.round(parseFloat(s)*1e6); if(s.includes('k'))return Math.round(parseFloat(s)*1e3); return Math.round(parseFloat(s)); };

let toastTimer;
function toast(msg, type='ok') {
  const el=$('toast'); el.textContent=msg; el.className='show '+type;
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>el.className='',2600);
}

function updateRangeStyle(el) {
  const pct = ((el.value-el.min)/(el.max-el.min)*100).toFixed(1);
  el.style.setProperty('--pct', pct+'%');
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cur = 'home';
let finFilter = { month: new Date().getMonth(), year: new Date().getFullYear(), person:'all' };
let choresFilter = 'pending';
let txData=[], choresData=[], notesData=[], eventsData=[], dreamsData=[], loveData=[];
let homeStats = { balance:'0Ä‘', chores:'0/0', dreams:'0%' };
let chartInst = null;
let aiHistory=[], aiLoading=false;
let micOn=false, recog=null;

const MONTHS = ['Th.1','Th.2','Th.3','Th.4','Th.5','Th.6','Th.7','Th.8','Th.9','Th.10','Th.11','Th.12'];
const NC = ['nc-1','nc-2','nc-3','nc-4','nc-5'];
const CAT = { travel:{l:'âœˆï¸ Du lá»‹ch',c:'dc-travel'}, home:{l:'ğŸ  Tá»• áº¥m',c:'dc-home'}, life:{l:'ğŸ’‘ Cuá»™c sá»‘ng',c:'dc-life'}, money:{l:'ğŸ’° TÃ i chÃ­nh',c:'dc-money'} };

// â”€â”€ DATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  const d=new Date(), days=['CN','T2','T3','T4','T5','T6','T7'];
  $('date-chip').textContent=`${days[d.getDay()]}, ${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
})();

// â”€â”€ PILL PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pickPill(el, groupId) {
  document.querySelectorAll('#'+groupId+' .pill').forEach(p=>{
    p.className='pill'; // reset
  });
  el.classList.add('on');
}
function getPill(groupId) {
  const a=document.querySelector('#'+groupId+' .pill.on');
  return a?a.dataset.v:'';
}

// â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) { $(id).classList.add('open'); }
function closeModal(id) { $(id).classList.remove('open'); }

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function go(name, btn) {
  cur=name;
  document.querySelectorAll('.nav-btn').forEach(b=>{ b.className='nav-btn'; });
  btn.className='nav-btn on';
  render();
}

function render() {
  const main=$('main');
  main.innerHTML='';
  const page=document.createElement('div');
  page.className='page';
  if (cur==='home')    renderHome(page);
  if (cur==='finance') { renderFinance(page); loadTx(); }
  if (cur==='chores')  { renderChores(page); loadChores(); }
  if (cur==='notes')   { renderNotes(page); loadNotes(); loadEvents(); }
  if (cur==='dreams')  { renderDreams(page); loadDreams(); }
  if (cur==='ai')      renderAI(page);
  main.appendChild(page);
  if (cur==='home') loadHomeStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome(p) {
  p.innerHTML=`
  <div class="welcome">
    <div class="welcome-title">ChÃ o Äáº¡t & TLinh â˜€ï¸</div>
    <div class="welcome-sub">Má»—i ngÃ y lÃ  má»™t trang má»›i Ä‘á»ƒ chÃºng mÃ¬nh cÃ¹ng viáº¿t<br>nÃªn cÃ¢u chuyá»‡n cá»§a hai ngÆ°á»i ğŸ’•</div>
  </div>
  <div class="stat-row">
    <div class="stat-box"><div class="stat-num" id="hs-balance">â€¦</div><div class="stat-label">Sá»‘ dÆ° thÃ¡ng</div></div>
    <div class="stat-box"><div class="stat-num" id="hs-chores">â€¦</div><div class="stat-label">Viá»‡c nhÃ </div></div>
    <div class="stat-box"><div class="stat-num" id="hs-dreams">â€¦</div><div class="stat-label">Æ¯á»›c mÆ¡</div></div>
  </div>
  <div class="home-grid">
    <div class="home-card hc-finance" onclick="go('finance',document.querySelector('[data-t=finance]'))"><span class="hc-emoji">ğŸ’°</span><div class="hc-title">Thu Chi</div><div class="hc-sub">Quáº£n lÃ½ ngÃ¢n sÃ¡ch</div></div>
    <div class="home-card hc-chores"  onclick="go('chores',document.querySelector('[data-t=chores]'))"><span class="hc-emoji">ğŸ§¹</span><div class="hc-title">Viá»‡c NhÃ </div><div class="hc-sub">PhÃ¢n cÃ´ng cÃ¹ng nhau</div></div>
    <div class="home-card hc-notes"   onclick="go('notes',document.querySelector('[data-t=notes]'))"><span class="hc-emoji">ğŸ“</span><div class="hc-title">Ghi ChÃº</div><div class="hc-sub">Sá»± kiá»‡n & nháº¯n nhá»</div></div>
    <div class="home-card hc-dreams"  onclick="go('dreams',document.querySelector('[data-t=dreams]'))"><span class="hc-emoji">ğŸŒŸ</span><div class="hc-title">Æ¯á»›c MÆ¡</div><div class="hc-sub">Má»¥c tiÃªu chung mÃ¬nh</div></div>
  </div>
  <div class="sec">ğŸ’Œ Nháº¯n Nhau Äi</div>
  <div class="love-wrap">
    <div class="love-input-row">
      <textarea id="love-txt" placeholder="Viáº¿t gÃ¬ Ä‘Ã³ ngá»t ngÃ o... ğŸŒ¸" style="min-height:44px"></textarea>
      <button class="btn btn-rose btn-sm" onclick="saveLove()">ğŸ’Œ Gá»­i</button>
    </div>
    <div class="love-list" id="love-list"></div>
  </div>`;
  loadLove();
}

async function loadHomeStats() {
  const from=new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString();
  const {data:txs}=await SB.from('transactions').select('amount,type').gte('created_at',from);
  let i=0,e=0; (txs||[]).forEach(t=>t.type==='income'?i+=Number(t.amount):e+=Number(t.amount));
  const hb=$('hs-balance'); if(hb) hb.textContent=fmt(i-e);
  const {data:ch}=await SB.from('chores').select('done');
  const tot=(ch||[]).length,dn=(ch||[]).filter(c=>c.done).length;
  const hc=$('hs-chores'); if(hc) hc.textContent=`${dn}/${tot}`;
  const {data:dr}=await SB.from('dreams').select('progress');
  const avg=(dr||[]).length?Math.round(dr.reduce((s,d)=>s+d.progress,0)/dr.length):0;
  const hd=$('hs-dreams'); if(hd) hd.textContent=avg+'%';
}

async function loadLove() {
  const {data}=await SB.from('love_notes').select('*').order('created_at',{ascending:false}).limit(5);
  const list=$('love-list'); if(!list) return;
  if(!(data||[]).length){list.innerHTML='';return;}
  list.innerHTML=(data||[]).map(n=>{
    const d=new Date(n.created_at);
    return `<div class="love-item"><span class="love-time">${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}</span>"${n.text}"</div>`;
  }).join('');
}

async function saveLove() {
  const txt=$('love-txt').value.trim(); if(!txt) return;
  await SB.from('love_notes').insert({text:txt});
  $('love-txt').value=''; toast('ğŸ’Œ ÄÃ£ gá»­i!'); loadLove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FINANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFinance(p) {
  p.innerHTML=`
  <div class="balance-hero">
    <div class="balance-label">Sá»‘ dÆ° â€” <span id="month-lbl">${MONTHS[finFilter.month]}/${finFilter.year}</span></div>
    <div class="balance-num" id="bal-num">â€¦</div>
    <div class="balance-split">
      <span class="bal-in">â–² <span id="bal-in">0Ä‘</span></span>
      <span class="bal-out">â–¼ <span id="bal-out">0Ä‘</span></span>
    </div>
  </div>
  <!-- filter -->
  <div class="filter-row">
    <div class="month-ctrl">
      <button onclick="prevMonth()">â—€</button>
      <span id="month-ctrl-lbl">${MONTHS[finFilter.month]}/${finFilter.year}</span>
      <button onclick="nextMonth()">â–¶</button>
    </div>
    <div class="pills" id="person-pills" style="margin:0">
      ${['all','Äáº¡t','TLinh','Cáº£ hai'].map((v,i)=>`<span class="pill${v===finFilter.person?' on':''}" data-v="${v}" onclick="pickPersonFilter(this)">${v==='all'?'Táº¥t cáº£':v}</span>`).join('')}
    </div>
  </div>
  <!-- add form -->
  <div class="card">
    <div class="card-title">â• ThÃªm Giao Dá»‹ch</div>
    <div class="pills" id="tx-type-pills">
      <span class="pill on" data-v="expense" onclick="pickPill(this,'tx-type-pills')">Chi tiÃªu</span>
      <span class="pill"    data-v="income"  onclick="pickPill(this,'tx-type-pills')">Thu nháº­p</span>
    </div>
    <div class="row2">
      <div class="field"><label>MÃ´ táº£</label><input id="tx-desc" placeholder="vd: tiá»n chá»£..."/></div>
      <div class="field"><label>Sá»‘ tiá»n</label><input id="tx-amt" type="number" placeholder="0"/></div>
    </div>
    <div class="row2">
      <div class="field"><label>Danh má»¥c</label>
        <select id="tx-cat">
          <option>ğŸ›’ Thá»±c pháº©m</option><option>ğŸ  NhÃ  cá»­a</option><option>ğŸš— Di chuyá»ƒn</option>
          <option>ğŸ’Š Sá»©c khá»e</option><option>ğŸ‰ Giáº£i trÃ­</option><option>ğŸ‘— Quáº§n Ã¡o</option>
          <option>ğŸ’¼ Thu nháº­p</option><option>ğŸ± ThÃº cÆ°ng</option><option>ğŸ KhÃ¡c</option>
        </select>
      </div>
      <div class="field"><label>NgÆ°á»i chi</label>
        <select id="tx-person"><option>Äáº¡t</option><option>TLinh</option><option>Cáº£ hai</option></select>
      </div>
    </div>
    <button class="btn btn-amber btn-full" onclick="addTx()">ğŸ’° ThÃªm Giao Dá»‹ch</button>
  </div>
  <!-- list -->
  <div class="card">
    <div class="card-title">ğŸ“‹ Giao Dá»‹ch</div>
    <div class="tx-list" id="tx-list"></div>
    <div class="chart-section" id="chart-section" style="display:none">
      <div class="chart-label">PhÃ¢n bá»• chi tiÃªu</div>
      <canvas id="fin-chart" style="max-height:190px"></canvas>
    </div>
  </div>`;
}

function pickPersonFilter(el) {
  document.querySelectorAll('#person-pills .pill').forEach(p=>p.className='pill');
  el.className='pill on';
  finFilter.person=el.dataset.v;
  loadTx();
}
function prevMonth(){finFilter.month--;if(finFilter.month<0){finFilter.month=11;finFilter.year--;}updateMonthLabel();loadTx();}
function nextMonth(){finFilter.month++;if(finFilter.month>11){finFilter.month=0;finFilter.year++;}updateMonthLabel();loadTx();}
function updateMonthLabel(){
  const lbl=MONTHS[finFilter.month]+'/'+finFilter.year;
  const a=$('month-lbl'), b=$('month-ctrl-lbl');
  if(a)a.textContent=lbl; if(b)b.textContent=lbl;
}

async function loadTx() {
  const from=new Date(finFilter.year,finFilter.month,1).toISOString();
  const to=new Date(finFilter.year,finFilter.month+1,0,23,59,59).toISOString();
  let q=SB.from('transactions').select('*').gte('created_at',from).lte('created_at',to).order('created_at',{ascending:false});
  if(finFilter.person!=='all') q=q.eq('person',finFilter.person);
  const {data}=await q;
  txData=data||[];
  renderTx();
}

async function addTx() {
  const desc=$('tx-desc').value.trim(), amt=parseFloat($('tx-amt').value);
  if(!desc||!amt||amt<=0){toast('Nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin nhÃ©!','err');return;}
  await SB.from('transactions').insert({desc,amount:amt,type:getPill('tx-type-pills')||'expense',cat:$('tx-cat').value,person:$('tx-person').value});
  $('tx-desc').value=''; $('tx-amt').value='';
  toast('âœ… ÄÃ£ ghi!'); loadTx(); loadHomeStats();
}

async function delTx(id) {
  await SB.from('transactions').delete().eq('id',id);
  toast('ğŸ—‘ï¸ ÄÃ£ xoÃ¡'); loadTx(); loadHomeStats();
}

function renderTx() {
  const list=$('tx-list'); if(!list) return;
  let inc=0,exp=0;
  txData.forEach(t=>t.type==='income'?inc+=Number(t.amount):exp+=Number(t.amount));
  const bn=$('bal-num'),bi=$('bal-in'),bo=$('bal-out');
  if(bn)bn.textContent=fmt(inc-exp);
  if(bi)bi.textContent=fmt(inc);
  if(bo)bo.textContent=fmt(exp);
  if(!txData.length){list.innerHTML='<div class="empty"><span class="empty-icon">ğŸ’¸</span>ChÆ°a cÃ³ giao dá»‹ch thÃ¡ng nÃ y</div>';return;}
  list.innerHTML=txData.map(t=>{
    const d=new Date(t.created_at);
    return `<div class="tx-item ${t.type}">
      <div style="flex:1">
        <div class="tx-desc">${t.cat} ${t.desc}</div>
        <div class="tx-meta">${t.person} Â· ${d.getDate()}/${d.getMonth()+1}</div>
      </div>
      <div class="tx-amt ${t.type}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</div>
      <button class="del-btn" onclick="delTx('${t.id}')">âœ•</button>
    </div>`;
  }).join('');
  // chart
  const expenses=txData.filter(t=>t.type==='expense');
  const cs=$('chart-section'); if(cs) cs.style.display=expenses.length?'block':'none';
  if(expenses.length) drawChart(expenses);
}

function drawChart(expenses) {
  const cv=$('fin-chart'); if(!cv) return;
  const cats={};
  expenses.forEach(t=>{cats[t.cat]=(cats[t.cat]||0)+Number(t.amount);});
  if(chartInst) chartInst.destroy();
  chartInst=new Chart(cv.getContext('2d'),{
    type:'doughnut',
    data:{labels:Object.keys(cats),datasets:[{data:Object.values(cats),
      backgroundColor:['#E8A87C','#7FAF8A','#9B8EC4','#C9A84C','#D4877A','#C8DFD0','#EEE0B0','#F5DCC8'],
      borderWidth:2,borderColor:'#FFFFFF'}]},
    options:{plugins:{legend:{position:'bottom',labels:{font:{family:'DM Sans',size:10},padding:10}}},cutout:'62%'}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChores(p) {
  p.innerHTML=`
  <div class="card">
    <div class="card-title">ğŸ§¹ Viá»‡c NhÃ  Chung MÃ¬nh</div>
    <div class="prog-bar-wrap">
      <div class="prog-head"><span>Tiáº¿n Ä‘á»™ hÃ´m nay</span><span id="ch-prog-txt">0/0</span></div>
      <div class="prog-track"><div class="prog-fill" id="ch-prog-fill" style="width:0%"></div></div>
    </div>
    <div class="pills" style="margin-bottom:.75rem" id="ch-filter-pills">
      <span class="pill on-sage on" data-v="pending" onclick="setChoreFilter(this,'pending')">ChÆ°a lÃ m</span>
      <span class="pill" data-v="all"   onclick="setChoreFilter(this,'all')">Táº¥t cáº£</span>
      <span class="pill" data-v="done"  onclick="setChoreFilter(this,'done')">ÄÃ£ xong</span>
    </div>
    <div class="chore-list" id="chore-list"></div>
  </div>
  <div class="card">
    <div class="card-title">â• ThÃªm Viá»‡c NhÃ </div>
    <div class="field"><label>TÃªn cÃ´ng viá»‡c</label><input id="ch-name" placeholder="vd: Rá»­a bÃ¡t, quÃ©t nhÃ ..."/></div>
    <div class="row2">
      <div class="field"><label>PhÃ¢n cÃ´ng</label>
        <select id="ch-assign"><option>Äáº¡t</option><option>TLinh</option><option>CÃ¹ng lÃ m ğŸ’•</option></select>
      </div>
      <div class="field"><label>Táº§n suáº¥t</label>
        <select id="ch-freq"><option>Háº±ng ngÃ y</option><option>Háº±ng tuáº§n</option><option>Háº±ng thÃ¡ng</option><option>Khi cáº§n</option></select>
      </div>
    </div>
    <button class="btn btn-sage btn-full" onclick="addChore()">ğŸ§¹ ThÃªm CÃ´ng Viá»‡c</button>
  </div>`;
}

function setChoreFilter(el,val) {
  choresFilter=val;
  document.querySelectorAll('#ch-filter-pills .pill').forEach(p=>p.className='pill');
  el.className='pill on-sage on';
  loadChores();
}

async function loadChores() {
  let q=SB.from('chores').select('*').order('created_at',{ascending:true});
  if(choresFilter==='pending') q=q.eq('done',false);
  if(choresFilter==='done')    q=q.eq('done',true);
  const {data}=await q;
  choresData=data||[];
  // get full count for progress
  const {data:all}=await SB.from('chores').select('done');
  const tot=(all||[]).length, dn=(all||[]).filter(c=>c.done).length;
  const pt=$('ch-prog-txt'), pf=$('ch-prog-fill');
  if(pt) pt.textContent=`${dn}/${tot}`;
  if(pf) pf.style.width=tot?(dn/tot*100)+'%':'0%';
  renderChores2();
}

function renderChores2() {
  const list=$('chore-list'); if(!list) return;
  if(!choresData.length){list.innerHTML='<div class="empty"><span class="empty-icon">âœ¨</span>KhÃ´ng cÃ³ viá»‡c nÃ o á»Ÿ Ä‘Ã¢y!</div>';return;}
  list.innerHTML=choresData.map(c=>`
    <div class="chore-item${c.done?' done':''}">
      <div class="chore-check" onclick="toggleChore('${c.id}',${c.done})">${c.done?'âœ“':''}</div>
      <div style="flex:1">
        <div class="chore-name">${c.name}</div>
        <div class="chore-assign">ğŸ‘¤ ${c.assign}</div>
      </div>
      <span class="chore-freq">${c.freq}</span>
      <button class="del-btn" onclick="delChore('${c.id}')">âœ•</button>
    </div>`).join('');
}

async function addChore() {
  const name=$('ch-name').value.trim(); if(!name){toast('Nháº­p tÃªn cÃ´ng viá»‡c nhÃ©!','err');return;}
  await SB.from('chores').insert({name,assign:$('ch-assign').value,freq:$('ch-freq').value,done:false});
  $('ch-name').value=''; toast('âœ… ÄÃ£ thÃªm!'); loadChores();
}
async function toggleChore(id,done) {
  await SB.from('chores').update({done:!done,done_at:!done?new Date().toISOString():null}).eq('id',id);
  loadChores(); loadHomeStats();
}
async function delChore(id) {
  await SB.from('chores').delete().eq('id',id); toast('ğŸ—‘ï¸ ÄÃ£ xoÃ¡'); loadChores();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNotes(p) {
  p.innerHTML=`
  <div class="card">
    <div class="card-title" style="margin-bottom:.6rem">ğŸ“… Sá»± Kiá»‡n Sáº¯p Tá»›i</div>
    <div class="event-list" id="ev-list"></div>
    <button class="btn btn-outline btn-sm" style="margin-top:.6rem" onclick="openModal('modal-event')">+ ThÃªm sá»± kiá»‡n</button>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“ Ghi ChÃº</div>
    <div class="notes-masonry" id="notes-grid"></div>
    <button class="btn btn-lav btn-full" onclick="openModal('modal-note')">+ ThÃªm Ghi ChÃº</button>
  </div>`;
}

async function loadNotes() {
  const {data}=await SB.from('notes').select('*').order('created_at',{ascending:false});
  notesData=data||[];
  const grid=$('notes-grid'); if(!grid) return;
  if(!notesData.length){grid.innerHTML='<div class="empty" style="grid-column:span 2"><span class="empty-icon">ğŸ““</span>ChÆ°a cÃ³ ghi chÃº nÃ o</div>';return;}
  grid.innerHTML=notesData.map(n=>{
    const d=new Date(n.created_at);
    return `<div class="note-card ${n.color||'nc-1'}">
      <button class="note-del" onclick="delNote('${n.id}')">âœ•</button>
      <div class="note-tag">${n.tag}</div>
      <div class="note-title">${n.title}</div>
      <div class="note-body">${n.body||''}</div>
      <div class="note-date">${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}</div>
    </div>`;
  }).join('');
}

async function addNote() {
  const title=$('n-title').value.trim(); if(!title){toast('Nháº­p tiÃªu Ä‘á» nhÃ©!','err');return;}
  await SB.from('notes').insert({title,body:$('n-body').value.trim(),tag:getPill('n-tag-pills')||'Ghi nhá»›',color:NC[Math.floor(Math.random()*5)]});
  $('n-title').value=''; $('n-body').value='';
  closeModal('modal-note'); toast('ğŸ“ ÄÃ£ lÆ°u!'); loadNotes();
}
async function delNote(id) {
  await SB.from('notes').delete().eq('id',id); toast('ğŸ—‘ï¸ ÄÃ£ xoÃ¡'); loadNotes();
}

async function loadEvents() {
  const today=new Date().toISOString().split('T')[0];
  const {data}=await SB.from('events').select('*').gte('event_date',today).order('event_date',{ascending:true});
  eventsData=data||[];
  const list=$('ev-list'); if(!list) return;
  if(!eventsData.length){list.innerHTML='<div class="empty"><span class="empty-icon">ğŸ—“ï¸</span>ChÆ°a cÃ³ sá»± kiá»‡n sáº¯p tá»›i</div>';return;}
  const mnames=['Th.1','Th.2','Th.3','Th.4','Th.5','Th.6','Th.7','Th.8','Th.9','Th.10','Th.11','Th.12'];
  list.innerHTML=eventsData.map(e=>{
    const d=new Date(e.event_date+'T00:00:00');
    const now=new Date(); now.setHours(0,0,0,0);
    const diff=Math.round((d-now)/86400000);
    const diffLbl=diff===0?'ğŸ”´ HÃ´m nay!':diff===1?'ğŸŸ¡ NgÃ y mai':`cÃ²n ${diff} ngÃ y`;
    return `<div class="event-item">
      <div class="ev-date"><div class="ev-day">${d.getDate()}</div><div class="ev-month">${mnames[d.getMonth()]}</div></div>
      <div style="flex:1">
        <div class="ev-name">${e.name}</div>
        <div class="ev-who">ğŸ‘¤ ${e.who} Â· <span class="ev-diff">${diffLbl}</span></div>
      </div>
      <span class="ev-badge ${e.type==='chung'?'ev-b-chung':'ev-b-rieng'}">${e.type==='chung'?'ğŸ’‘':'ğŸ‘¤'}</span>
      <button class="del-btn" onclick="delEvent('${e.id}')">âœ•</button>
    </div>`;
  }).join('');
}

async function addEvent() {
  const name=$('ev-name').value.trim(), date=$('ev-date').value;
  if(!name||!date){toast('Nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin nhÃ©!','err');return;}
  await SB.from('events').insert({name,event_date:date,type:getPill('ev-type-pills')||'chung',who:$('ev-who').value});
  $('ev-name').value=''; $('ev-date').value='';
  closeModal('modal-event'); toast('ğŸ“… ÄÃ£ lÆ°u!'); loadEvents();
}
async function delEvent(id) {
  await SB.from('events').delete().eq('id',id); toast('ğŸ—‘ï¸ ÄÃ£ xoÃ¡'); loadEvents();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DREAMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDreams(p) {
  p.innerHTML=`
  <div style="background:linear-gradient(135deg,#FDF8EE,#F8EEFF);border-radius:var(--r);border:1px solid var(--border);padding:1.1rem 1.1rem .9rem;margin-bottom:.8rem;">
    <div class="card-title">ğŸŒŸ Æ¯á»›c MÆ¡ Cá»§a ChÃºng MÃ¬nh</div>
    <p style="font-size:.76rem;color:var(--ink2);font-style:italic;margin-bottom:1rem;">"Hai ngÆ°á»i cÃ¹ng mÆ¡, Æ°á»›c mÆ¡ sáº½ thÃ nh hiá»‡n thá»±c ğŸ’«"</p>
    <div id="dream-list"></div>
  </div>
  <button class="btn btn-peach btn-full" onclick="openModal('modal-dream')">âœ¨ ThÃªm Æ¯á»›c MÆ¡ Má»›i</button>`;
}

async function loadDreams() {
  const {data}=await SB.from('dreams').select('*').order('created_at',{ascending:true});
  dreamsData=data||[];
  const list=$('dream-list'); if(!list) return;
  if(!dreamsData.length){list.innerHTML='<div class="empty"><span class="empty-icon">ğŸŒˆ</span>CÃ¹ng nhau viáº¿t ra nhá»¯ng Æ°á»›c mÆ¡ nhÃ©!</div>';return;}
  list.innerHTML=dreamsData.map(d=>{
    const cat=CAT[d.cat]||CAT.travel;
    return `<div class="dream-item${d.done?' done':''}">
      <div class="dr-top">
        <div class="dr-title">${d.title}</div>
        <span class="dr-cat ${cat.c}">${cat.l}</span>
      </div>
      ${d.note?`<div class="dr-note">${d.note}</div>`:''}
      <div class="dr-prog-label"><span>Tiáº¿n Ä‘á»™</span><span id="dpv-${d.id}">${d.progress}%</span></div>
      <div class="dr-track"><div class="dr-fill" id="drf-${d.id}" style="width:${d.progress}%"></div></div>
      <input type="range" min="0" max="100" value="${d.progress}" style="--pct:${d.progress}%"
        oninput="previewDream('${d.id}',this.value);updateRangeStyle(this)"
        onchange="saveDreamProgress('${d.id}',this.value)"/>
      <div class="dr-footer">
        <button class="dr-done-btn" onclick="toggleDream('${d.id}',${d.done})">${d.done?'âœ“ ÄÃ£ hoÃ n thÃ nh!':'ğŸ¯ ÄÃ¡nh dáº¥u hoÃ n thÃ nh'}</button>
        <button class="del-btn" onclick="delDream('${d.id}')">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

function previewDream(id,val) {
  const lbl=$(`dpv-${id}`), fill=$(`drf-${id}`);
  if(lbl) lbl.textContent=val+'%';
  if(fill) fill.style.width=val+'%';
}
async function saveDreamProgress(id,val) {
  await SB.from('dreams').update({progress:parseInt(val)}).eq('id',id);
  loadHomeStats();
}
async function toggleDream(id,done) {
  await SB.from('dreams').update({done:!done,progress:!done?100:undefined}).eq('id',id);
  loadDreams(); loadHomeStats();
}
async function delDream(id) {
  await SB.from('dreams').delete().eq('id',id); toast('ğŸ—‘ï¸ ÄÃ£ xoÃ¡'); loadDreams(); loadHomeStats();
}
async function addDream() {
  const title=$('dr-title').value.trim(); if(!title){toast('Nháº­p tÃªn Æ°á»›c mÆ¡ nhÃ©!','err');return;}
  await SB.from('dreams').insert({title,note:$('dr-note').value.trim(),cat:getPill('dr-cat-pills')||'travel',progress:parseInt($('dr-progress').value)||0,done:false});
  $('dr-title').value=''; $('dr-note').value=''; $('dr-progress').value=0;
  closeModal('modal-dream'); toast('ğŸŒŸ ÄÃ£ thÃªm!'); loadDreams(); loadHomeStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUGGESTS=[
  ['ğŸ›’ Äi chá»£','HÃ´m nay Ä‘i chá»£ 120k vÃ  mua cÃ¡t mÃ¨o 80k'],
  ['âœ… Xong viá»‡c','Dá»n khay mÃ¨o vÃ  quÃ©t nhÃ  xong rá»“i'],
  ['ğŸ’ Æ¯á»›c mÆ¡','Tiáº¿t kiá»‡m Ä‘Ã¡m cÆ°á»›i thÃªm 2 triá»‡u rá»“i'],
  ['ğŸ“ Ghi chÃº','Nháº¯c mua thuá»‘c táº©y giun cho mÃ¨o'],
  ['ğŸ’° LÆ°Æ¡ng','LÆ°Æ¡ng thÃ¡ng nÃ y 8 triá»‡u vá» rá»“i'],
];
const AI_WELCOME=`ChÃ o Äáº¡t & TLinh! Tá»› lÃ  trá»£ lÃ½ Tá»• áº¤m ğŸ¡<br><br>Chá»‰ cáº§n nháº¯n tá»± nhiÃªn, tá»› tá»± ghi vÃ o Ä‘Ãºng chá»— nhÃ©!<br><br>ğŸ’° <i>"Äi chá»£ 120k, mua cÃ¡t mÃ¨o 80k"</i><br>ğŸ± <i>"Dá»n khay mÃ¨o vÃ  quÃ©t nhÃ  xong"</i><br>ğŸŒŸ <i>"Tiáº¿t kiá»‡m cÆ°á»›i thÃªm 2 triá»‡u"</i><br>ğŸ“ <i>"Nháº¯c mua thuá»‘c táº©y giun mÃ¨o"</i>`;

function renderAI(p) {
  p.innerHTML=`
  <div class="ai-banner">
    <h3>ğŸ¤– Trá»£ LÃ½ Tá»• áº¤m</h3>
    <p>Nháº¯n tá»± nhiÃªn â€” tá»› tá»± ghi vÃ o Ä‘Ãºng chá»— cho cáº­u ğŸŒ¸</p>
  </div>
  <div class="suggest-wrap">${SUGGESTS.map(s=>`<button class="suggest-chip" onclick="fillAI('${s[1].replace(/'/g,"\\'")}')"> ${s[0]}</button>`).join('')}</div>
  <div class="chat-box">
    <div class="chat-msgs" id="ai-msgs">
      <div class="msg ai"><div class="msg-av">ğŸ¤–</div><div class="msg-bub">${AI_WELCOME}</div></div>
    </div>
    <div class="chat-input-row">
      <button class="mic-btn" id="mic-btn" onclick="toggleMic()" title="Giá»ng nÃ³i">ğŸ¤</button>
      <textarea id="ai-in" placeholder="Nháº¯n gÃ¬ Ä‘Ã³... vd: hÃ´m nay Äƒn sÃ¡ng 45k" rows="1"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAI();}"
        oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,90)+'px'"></textarea>
      <button class="send-btn" id="ai-send" onclick="sendAI()">â¤</button>
    </div>
  </div>
  <div class="tip-card">
    ğŸ›’ <b>Chi tiÃªu:</b> "mua rau 30k, thá»‹t 80k"<br>
    ğŸ’° <b>Thu nháº­p:</b> "lÆ°Æ¡ng thÃ¡ng 8 vá» 8 triá»‡u"<br>
    âœ… <b>Viá»‡c nhÃ :</b> "xong rá»­a bÃ¡t vÃ  lau nhÃ "<br>
    ğŸŒŸ <b>Æ¯á»›c mÆ¡:</b> "tiáº¿t kiá»‡m cÆ°á»›i thÃªm 2 triá»‡u"<br>
    ğŸ“ <b>Ghi chÃº:</b> "nhá»› mua thuá»‘c táº©y giun mÃ¨o"<br>
    ğŸ± <b>MÃ¨o:</b> "cho cáº£ 5 bÃ© Äƒn xong rá»“i"
  </div>`;
}

function fillAI(t) { const el=$('ai-in'); if(el){el.value=t;el.focus();} }

function addMsg(role,html,tag) {
  const box=$('ai-msgs'); if(!box) return null;
  const d=document.createElement('div'); d.className='msg '+role;
  const av=document.createElement('div'); av.className='msg-av'; av.textContent=role==='ai'?'ğŸ¤–':'ğŸ¡';
  const bub=document.createElement('div'); bub.className='msg-bub'; bub.innerHTML=html;
  if(tag){const t=document.createElement('div');t.innerHTML=`<span class="act-tag ${tag.c}">${tag.l}</span>`;bub.appendChild(t);}
  d.appendChild(av); d.appendChild(bub); box.appendChild(d);
  box.scrollTop=box.scrollHeight; return bub;
}

async function sendAI() {
  const inp=$('ai-in'); if(!inp) return;
  const text=inp.value.trim(); if(!text||aiLoading) return;
  aiLoading=true; inp.value=''; inp.style.height='auto';
  const sb=$('ai-send'); if(sb) sb.disabled=true;
  addMsg('user',text);
  aiHistory.push({role:'user',content:text});
  const typBub=addMsg('ai','<div class="typing-dots"><span></span><span></span><span></span></div>');

  const ctx={
    transactions:txData.slice(0,8).map(t=>({desc:t.desc,amount:t.amount,type:t.type,cat:t.cat})),
    chores:choresData.map(c=>({name:c.name,done:c.done})),
    dreams:dreamsData.map(d=>({title:d.title,progress:d.progress}))
  };
  const sys=`Báº¡n lÃ  trá»£ lÃ½ "Tá»• áº¤m". Gia Ä‘Ã¬nh: Äáº¡t vÃ  TLinh, 5 con mÃ¨o. Má»¥c tiÃªu: tiáº¿t kiá»‡m káº¿t hÃ´n, xÃ¢y nhÃ , má»Ÿ tiá»‡m hoa.
Dá»¯ liá»‡u: ${JSON.stringify(ctx)}
Tráº£ vá» JSON duy nháº¥t (khÃ´ng cÃ³ text ngoÃ i JSON):
{"reply":"...","actions":[{"type":"ADD_TRANSACTION","data":{"desc":"","amount":0,"transType":"expense|income","cat":"ğŸ›’ Thá»±c pháº©m|ğŸ  NhÃ  cá»­a|ğŸš— Di chuyá»ƒn|ğŸ’Š Sá»©c khá»e|ğŸ‰ Giáº£i trÃ­|ğŸ‘— Quáº§n Ã¡o|ğŸ’¼ Thu nháº­p|ğŸ± ThÃº cÆ°ng|ğŸ KhÃ¡c","person":"Äáº¡t|TLinh|Cáº£ hai"}}]}
Loáº¡i action: ADD_TRANSACTION | COMPLETE_CHORE({"name":""}) | UPDATE_DREAM_PROGRESS({"title":"","progress":0}) | ADD_NOTE({"title":"","body":"","tag":"Ghi nhá»›|CÃ¹ng nhau|Mua sáº¯m|Ã tÆ°á»Ÿng"})
Quy Ä‘á»•i: k=*1000, triá»‡u=*1000000. Pháº£n há»“i thÃ¢n thiá»‡n, emoji ğŸ± khi liÃªn quan mÃ¨o.`;

  try {
    const res=await fetch('/api/ai',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,system:sys,messages:aiHistory})});
    const data=await res.json();
    const raw=data.content?.[0]?.text||'{}';
    let parsed; try{parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());}catch{parsed={reply:raw,actions:[]};}
    aiHistory.push({role:'assistant',content:raw});
    let tag=null;
    for(const a of (parsed.actions||[])){
      if(a.type==='ADD_TRANSACTION'&&a.data){
        await SB.from('transactions').insert({desc:a.data.desc||'Chi tiÃªu',amount:a.data.amount||0,type:a.data.transType||'expense',cat:a.data.cat||'ğŸ KhÃ¡c',person:a.data.person||'Cáº£ hai'});
        tag={l:a.data.transType==='income'?'ğŸ’° ÄÃ£ ghi thu':'ğŸ’¸ ÄÃ£ ghi chi',c:'at-f'};
        if(cur==='finance')loadTx(); loadHomeStats();
      }
      if(a.type==='COMPLETE_CHORE'&&a.data){
        const kw=(a.data.name||'').toLowerCase();
        const ch=choresData.find(c=>c.name.toLowerCase().includes(kw));
        if(ch){await SB.from('chores').update({done:true,done_at:new Date().toISOString()}).eq('id',ch.id);if(cur==='chores')loadChores();}
        tag={l:'âœ… ÄÃ£ Ä‘Ã¡nh dáº¥u xong',c:'at-c'};
      }
      if(a.type==='UPDATE_DREAM_PROGRESS'&&a.data){
        const kw=(a.data.title||'').toLowerCase();
        const dr=dreamsData.find(d=>d.title.toLowerCase().includes(kw));
        if(dr){await SB.from('dreams').update({progress:Math.min(100,a.data.progress||0)}).eq('id',dr.id);if(cur==='dreams')loadDreams();loadHomeStats();}
        tag={l:'ğŸŒŸ Cáº­p nháº­t Æ°á»›c mÆ¡',c:'at-d'};
      }
      if(a.type==='ADD_NOTE'&&a.data){
        await SB.from('notes').insert({title:a.data.title||'Ghi chÃº',body:a.data.body||'',tag:a.data.tag||'Ghi nhá»›',color:NC[Math.floor(Math.random()*5)]});
        if(cur==='notes')loadNotes();
        tag={l:'ğŸ“ ÄÃ£ lÆ°u ghi chÃº',c:'at-n'};
      }
    }
    if(typBub){typBub.innerHTML=parsed.reply||'Tá»› Ä‘Ã£ xá»­ lÃ½ rá»“i nhÃ©! ğŸŒ¸'; if(tag){const t=document.createElement('div');t.innerHTML=`<span class="act-tag ${tag.c}">${tag.l}</span>`;typBub.appendChild(t);}}
  } catch(e) {
    if(typBub) typBub.innerHTML='Ã”i cÃ³ lá»—i káº¿t ná»‘i rá»“i! Cáº­u thá»­ láº¡i nhÃ© ğŸ˜…';
  }
  aiLoading=false; const sb2=$('ai-send'); if(sb2)sb2.disabled=false;
  const box=$('ai-msgs'); if(box) box.scrollTop=box.scrollHeight;
}

function toggleMic() {
  const btn=$('mic-btn');
  if(!('webkitSpeechRecognition'in window)&&!('SpeechRecognition'in window)){toast('Thá»­ Chrome nhÃ©!','err');return;}
  if(micOn){recog&&recog.stop();return;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recog=new SR(); recog.lang='vi-VN'; recog.interimResults=false;
  recog.onstart=()=>{micOn=true;if(btn)btn.classList.add('rec');};
  recog.onresult=e=>{const el=$('ai-in');if(el)el.value=e.results[0][0].transcript;};
  recog.onend=()=>{micOn=false;if(btn)btn.classList.remove('rec');};
  recog.start();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REALTIME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SB.channel('toam-rt')
  .on('postgres_changes',{event:'*',schema:'public',table:'transactions'},()=>{if(cur==='finance')loadTx();loadHomeStats();})
  .on('postgres_changes',{event:'*',schema:'public',table:'chores'},()=>{if(cur==='chores')loadChores();loadHomeStats();})
  .on('postgres_changes',{event:'*',schema:'public',table:'notes'},()=>{if(cur==='notes')loadNotes();})
  .on('postgres_changes',{event:'*',schema:'public',table:'events'},()=>{if(cur==='notes')loadEvents();})
  .on('postgres_changes',{event:'*',schema:'public',table:'dreams'},()=>{if(cur==='dreams')loadDreams();loadHomeStats();})
  .on('postgres_changes',{event:'*',schema:'public',table:'love_notes'},()=>{if(cur==='home')loadLove();})
  .subscribe();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
render();
</script>
</body>
</html>
